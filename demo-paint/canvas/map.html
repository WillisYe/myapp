<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #source {
      display: none;
    }

    .canvas-wrap {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
  </style>
</head>

<body>
  <img id="source" src="img/map.jpg" alt="" srcset="">

  <div class="canvas-wrap">
    <canvas id="canvas-left" width="135" height="905"></canvas>
    <canvas id="canvas-right" width="1355" height="805"></canvas>
  </div>

  <script>
    const canvas_left = document.getElementById("canvas-left");
    const ctx_left = canvas_left.getContext("2d");

    const canvas_right = document.getElementById("canvas-right");
    const ctx_right = canvas_right.getContext("2d");

    const image = document.getElementById("source");

    const OFFSET = 3;
    const RANGEMIN = 5000;

    image.addEventListener("load", () => {
      ctx_left.drawImage(image, 10, 10, 115, 780, 0, 0, 135, canvas_left.height - 40);
      drawRightCanvas();
    });

    canvas_left.addEventListener("click", (e) => handleClick(e, ctx_left));
    canvas_right.addEventListener("click", (e) => handleClick(e, ctx_right));

    function handleClick(e, ctx_cur) {
      const pixel = ctx_cur.getImageData(e.offsetX, e.offsetY, 1, 1).data;
      if (pixel[0] === 255 && pixel[1] === 0 && pixel[2] === 0) return;
      if (pixel[0] === 255 && pixel[1] === 255 && pixel[2] === 255) {
        drawRightCanvas();
        return
      };

      const altitude = e.target.id === "canvas-left"
        ? getAltitudeByY(e)
        : getAltitudeByPixel(pixel);

      displayAltitude(ctx_left, pixel, altitude);
      setSameColor(pixel);
    }

    function displayAltitude(ctx, pixel, altitude) {
      ctx.fillStyle = `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
      ctx.fillRect(0, canvas_left.height - 40, 135, 40);

      ctx.fillStyle = `#fff`;
      ctx.fillRect(10, canvas_left.height - 30, 115, 20);

      ctx.font = "20px serif";
      ctx.fillStyle = `#000`;
      ctx.fillText(`海拔${altitude}m`, 20, canvas_left.height - 13);
    }

    function getImagePosition(e) {
      const rect = e.target.getBoundingClientRect();
      return { x: e.clientX - rect.left, y: e.clientY - rect.top };
    }

    function drawRightCanvas() {
      ctx_right.clearRect(0, 0, canvas_right.width, canvas_right.height);
      ctx_right.drawImage(image, 340, 30, 1355, 805, 0, 0, 1355, 805);
      ctx_right.fillStyle = "#ffffff";
      ctx_right.fillRect(0, 725, 90, 805);
    }

    function getAltitudeByY(e, y = getImagePosition(e).y) {
      const altitude = Math.round((y - 10) * (-790 - 7543) / (855 - 10) + 7543);
      return altitude;
    }

    function getAltitudeByPixel(pixel) {
      const y = getXYSameColor(pixel)?.y;
      return y ? getAltitudeByY(null, y) : 0;
    }

    function getXYSameColor(pixel, offset = OFFSET) {
      const imageData = ctx_left.getImageData(0, 0, 135, canvas_left.height - 40);
      const length = imageData.data.length;
      let start = 0;
      let end = length - 4;

      while (start <= end) {
        const startIndex = pixel[1] < 128 ? start : end;
        const endIndex = pixel[1] < 128 ? end : start;

        const startPixel = imageData.data.slice(startIndex, startIndex + 3);
        const endPixel = imageData.data.slice(endIndex, endIndex + 3);

        if (colorSimilarity(pixel, startPixel) < offset) {
          if (colorSimilarity(pixel, [255, 255, 255]) > 10) {
            const x = Math.floor(startIndex % 4 / 135);
            const y = Math.floor(startIndex / 4 / 135);
            return { x, y };
          }
        }

        if (colorSimilarity(pixel, endPixel) < offset) {
          if (colorSimilarity(pixel, [255, 255, 255]) > 10) {
            const x = Math.floor(endIndex % 4 / 135);
            const y = Math.floor(endIndex / 4 / 135);
            return { x, y };
          }
        }

        start += 4;
        end -= 4;
      }

      return getXYSameColor(pixel, offset + OFFSET);
    }

    function setSameColor(color, offset = OFFSET) {
      // 将相同海拔地区的颜色标记为红色
      drawRightCanvas();
      const imageData = ctx_right.getImageData(0, 0, canvas_right.width, canvas_right.height);
      let count = 0;
      const length = imageData.data.length;
      let start = 0;
      let end = length - 4;

      while (start <= end) {
        const startIndex = start;
        const endIndex = end;

        const startPixel = imageData.data.slice(startIndex, startIndex + 3);
        const endPixel = imageData.data.slice(endIndex, endIndex + 3);

        if (colorSimilarity(startPixel, color) < offset) {
          if (colorSimilarity(startPixel, [255, 255, 255]) > 10) {
            imageData.data[startIndex] = 255;
            imageData.data[startIndex + 1] = 0;
            imageData.data[startIndex + 2] = 0;
            count++;
          }
        }

        if (colorSimilarity(endPixel, color) < offset) {
          if (colorSimilarity(endPixel, [255, 255, 255]) > 10) {
            imageData.data[endIndex] = 255;
            imageData.data[endIndex + 1] = 0;
            imageData.data[endIndex + 2] = 0;
            count++;
          }
        }

        start += 4;
        end -= 4;
      }
      ctx_right.putImageData(imageData, 0, 0);
      if (count < RANGEMIN && offset / OFFSET < 5) {
        setSameColor(color, offset + OFFSET);
      }
    }

    function colorSimilarity(color1, color2) {
      const r1 = color1[0], g1 = color1[1], b1 = color1[2];
      const r2 = color2[0], g2 = color2[1], b2 = color2[2];
      const distance = Math.sqrt(
        Math.pow(r1 - r2, 2) +
        Math.pow(g1 - g2, 2) +
        Math.pow(b1 - b2, 2)
      );
      return distance;
    }
  </script>
</body>

</html>